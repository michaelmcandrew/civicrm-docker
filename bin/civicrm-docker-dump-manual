#!/bin/env php
<?php

// Initialise variables
$pwd = $_SERVER['PWD'];
$projectName = basename($pwd);
// Warn if we do not have a valid project name
if (!strlen($projectName)) {
    trigger_error("Could not detect project name", E_USER_WARNING);
}
$tempDir = "/tmp/civicrm-docker-dump.$projectName";
$dumpScript = "/tmp/civicrm-docker-dump.$projectName.sync.sh";

// Choose the json to read configuration from
if (isset($argv[1])) {
    $environment = $argv[1];
    $definitionFile = "$pwd/docker/$environment/civicrm-docker-dump-manual.json";
} else {
    $definitionFile = "$pwd/civicrm-docker-dump-manual.json";
}

// Check that the configuration file exists
if (!file_exists($definitionFile)) {
    throw new Exception("Can't find a civicrm-docker-dump-manual configuration file");
}

// Load definition from json
$definition = json_decode(file_get_contents($definitionFile), 1);

// Create temp directory
$lines[] = "rm -rf {$tempDir}";
$lines[] = "mkdir {$tempDir}";

// Dump databases
foreach ($definition['databases'] as $dbKey => $database) {
    // TODO: consider compressing these while in transit
    if (isset($database['defaults_extra_file'])) {
        $lines[] = "ssh {$projectName} mysqldump --defaults-extra-file={$database['defaults_extra_file']} --single-transaction --skip-triggers {$database['name']} > {$tempDir}/{$dbKey}.sql";
    } else {
        $lines[] = "ssh {$projectName} mysqldump --single-transaction --skip-triggers {$database['name']} > {$tempDir}/{$dbKey}.sql";
    }
}

// Tar files
foreach ($definition['directories'] as $dirKey => $directory) {
    $lines[] = "ssh {$projectName} tar -cz -C {$directory['src']} . > {$tempDir}/{$dirKey}.tar.gz";
}

// Generate state.json
$lines[] = "cat << EOF > {$tempDir}/state.json";
$state = [
    'project' => $projectName,
    'databases' => array_keys($definition['databases']),
    'directories' => array_map(function ($dir) {
        return $dir['dest'];
    }, $definition['directories']),
];
$lines[] = json_encode($state, JSON_PRETTY_PRINT);
$lines[] = "EOF";
$lines[] = "OUTFILE={$projectName}.$(date +%Y%m%dT%H%M%S).tar.gz";

if (isset($environment)) {
    $lines[] = "tar -cz -C $tempDir . -f $pwd/state/$environment/\${OUTFILE}";
} else {
    $lines[] = "tar -cz -C {$tempDir} . -f {$pwd}/state/\${OUTFILE}";
}

$lines[] = "echo \$OUTFILE";
$lines[] = "rm -rf $tempDir";

// Abort if we have encountered any errors (e.g. due to missing variables in
// the json definition, etc.)
if (error_get_last()) {
    echo "Some errors occured - aborting manual dump.\n";
    exit;
}
//TODO: add -d --dry-run option to print echo rather than execute commands
file_put_contents($dumpScript, implode("\n", $lines) . "\n");
passthru("bash $dumpScript");
unlink($dumpScript);
